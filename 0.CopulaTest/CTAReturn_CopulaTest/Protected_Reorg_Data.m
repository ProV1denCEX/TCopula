%% 0. Load Data
clc
clear;
load('cFutureMarketData.mat');

cNv2Load = dir(fullfile(cd, ['dNv_*', '.mat']));
cNv2Load = {cNv2Load.name}';
cNv2Allocate.Name = [];
cNv2Allocate.Data = [];

for iNv = 1 : length(cNv2Load)
    load(cNv2Load{iNv})
    cNv2Allocate(iNv).Name = cNv2Load{iNv}(5 : end - 4);
    eval(['cNv2Allocate(iNv).Data = ', cNv2Load{iNv}(1 : end - 4), ';'])
end

%% 1. Reorgnize Data as LYZ form
[nMaxLen, nlocation] = max(cell2mat(cellfun(@(x) length(x), {cNv2Allocate.Data}, 'UniformOutput', 0)));

dAllReturn = zeros(nMaxLen, length(cNv2Allocate) + 1);
dAllReturn(:, 1) = cNv2Allocate(nlocation).Data(:, 1);

for iSpecies = 1 : length(cNv2Allocate)
    dMain = cNv2Allocate(iSpecies).Data;
    dReturn = [dMain(2 : end, 1), diff(dMain(:, 2)) ./ dMain(1 : end - 1, 2)];
    dReturn(isnan(dReturn(:, 2)), 2) = 0;
    [~, dLocation_In, dLocation_Out] = intersect(dAllReturn(:, 1), dReturn(:, 1));
    dAllReturn(dLocation_In, iSpecies + 1) = dReturn(dLocation_Out, 2);
end

dLocated = dAllReturn == inf | dAllReturn == -inf;
dAllReturn(dLocated) = 0;
dAllReturn = dAllReturn(dAllReturn(:, 1) >= 20110804, :);

cDate = cellstr(datestr(datenum(num2str(dAllReturn(:, 1)), 'yyyymmdd'), 'yyyy/mm/dd hh:MM'));

cNv2Allocate(1).Name = 'Finance'; % 0
cNv2Allocate(3).Name = 'Precious'; % 1
cNv2Allocate(4).Name = 'Metal'; % 2
cNv2Allocate(5).Name = 'Black'; % 3
cNv2Allocate(6).Name= 'Non-Metal Meterial'; % 4
cNv2Allocate(7).Name = ' Energy'; % 5
cNv2Allocate(8).Name = 'Chemical'; % 6
cNv2Allocate(9).Name = 'Cereals'; % 7
cNv2Allocate(10).Name = 'Oil'; % 8
cNv2Allocate(11).Name = 'Soft'; % 9
cNv2Allocate(2).Name = 'Agricultural Extra'; % 10
cName = {'Date', cNv2Allocate.Name};

cFile2Output = num2cell(dAllReturn(:, 2 : end));
cFile2Output = [cName; [cDate, cFile2Output]];
xlswrite('CTA_Species_Return.xlsx', cFile2Output);


% [nMaxLen, nlocation] = max(cell2mat(cellfun(@(x) length(x), {cFutureMarketData.Data_Main_Hold}, 'UniformOutput', 0)));
% 
% dAllReturn = zeros(nMaxLen, length(cFutureMarketData) + 1);
% dAllReturn(:, 1) = cFutureMarketData(nlocation).Data_Main_Hold(:, 1);
% 
% for iSpecies = 1 : length(cFutureMarketData)
%     dMain = cFutureMarketData(iSpecies).Data_Main_Hold(:, [1, 5]);
%     dReturn = [dMain(2 : end, 1), diff(dMain(:, 2)) ./ dMain(1 : end - 1, 2)];
%     dReturn(isnan(dReturn(:, 2)), 2) = 0;
%     [~, dLocation_In, dLocation_Out] = intersect(dAllReturn(:, 1), dReturn(:, 1));
%     dAllReturn(dLocation_In, iSpecies + 1) = dReturn(dLocation_Out, 2);
% end
% dLocated = dAllReturn == inf | dAllReturn == -inf;
% dAllReturn(dLocated) = 0;
% dAllReturn = dAllReturn(dAllReturn(:, 1) >= 20110804, :);
% dLocated = dAllReturn == 0;
% dAllReturn(dLocated) = 1.03 ^ (1 / 250) - 1;
% 
% cDate = cellstr(datestr(datenum(num2str(dAllReturn(:, 1)), 'yyyymmdd'), 'yyyy/mm/dd hh:MM'));
% 
% cName = {'Date', cFutureMarketData.Code};
% cFile2Output = num2cell(dAllReturn(:, 2 : end));
% cFile2Output = [cName; [cDate, cFile2Output]];
% xlswrite('CTAReturn.xlsx', cFile2Output);

%% 2. Correlation
dCorr = corrcoef(dAllReturn(:, 2 : end));
dCorr(isnan(dCorr)) = 0;

% createfigure(dCorr, cName(2 : end));
% 
% sPath = '.\';
% sFileName = 'Corr of CTA Return';
% saveas(gcf, strcat(sPath, sFileName,'.fig'),'fig')
% saveas(gcf, strcat(sPath, sFileName,'.tif'),'tif')

dTime = floor(dAllReturn(:, 1) / 10000);
dYear = unique(dTime);

for iYear = dYear(1) : dYear(end)
    dLocated = dAllReturn(:, 1) > iYear * 10000 & dAllReturn(:, 1) < (iYear + 1) * 10000;
    dTempCorr = corrcoef(dAllReturn(dLocated, 2 : end));
    dTempCorr(isnan(dTempCorr)) = 0;
    cTemp{iYear - dYear(1) + 1} = dTempCorr;
end

dFnorm = [];
for iCorr = 1 : length(cTemp)
    
    for iTest = 1 : length(cTemp)
            dFnorm(iCorr, iTest) = norm(cTemp{iCorr} - cTemp{iTest}, 'fro');
            
            if iCorr < iTest
                dFnorm(iCorr, iTest) = 0;
            else
            end
    end
    
end

% createheat(dFnorm, num2cell(dYear))
% sPath = '.\';
% sFileName = 'F-norm Raw';
% saveas(gcf, strcat(sPath, sFileName,'.fig'),'fig')
% saveas(gcf, strcat(sPath, sFileName,'.tif'),'tif')

y = copulacdf('t',dAllReturn(:, 2 : end),dCorr, length(dCorr));




 function createfigure(colordata1, cName)
%CREATEFIGURE(colordata1)
%  COLORDATA1:  colordata

%  由 MATLAB 于 29-Oct-2018 01:51:35 自动生成

% 创建 figure
figure1 = figure('Colormap',...
    [0 0.450980395078659 0.74117648601532;0.0322580635547638 0.468690693378448 0.749525606632233;0.0645161271095276 0.48640102148056 0.75787478685379;0.0967741906642914 0.504111349582672 0.766223907470703;0.129032254219055 0.521821618080139 0.774573087692261;0.161290317773819 0.539531946182251 0.782922208309174;0.193548381328583 0.557242274284363 0.791271388530731;0.225806444883347 0.57495254278183 0.799620509147644;0.25806450843811 0.592662870883942 0.807969629764557;0.290322571992874 0.610373198986053 0.816318809986115;0.322580635547638 0.628083467483521 0.824667930603027;0.354838699102402 0.645793795585632 0.833017110824585;0.387096762657166 0.663504123687744 0.841366231441498;0.419354826211929 0.681214451789856 0.849715352058411;0.451612889766693 0.698924720287323 0.858064532279968;0.483870953321457 0.716635048389435 0.866413652896881;0.516129016876221 0.734345376491547 0.874762833118439;0.548387110233307 0.752055644989014 0.883111953735352;0.580645143985748 0.769765973091125 0.891461133956909;0.612903237342834 0.787476301193237 0.899810254573822;0.645161271095276 0.805186569690704 0.908159375190735;0.677419364452362 0.822896897792816 0.916508555412292;0.709677398204803 0.840607225894928 0.924857676029205;0.74193549156189 0.858317494392395 0.933206856250763;0.774193525314331 0.876027822494507 0.941555976867676;0.806451618671417 0.893738150596619 0.949905097484589;0.838709652423859 0.91144847869873 0.958254277706146;0.870967745780945 0.929158747196198 0.966603398323059;0.903225779533386 0.946869075298309 0.974952578544617;0.935483872890472 0.964579403400421 0.98330169916153;0.967741906642914 0.982289671897888 0.991650879383087;1 1 1;1 0.96875 0.96875;1 0.9375 0.9375;1 0.90625 0.90625;1 0.875 0.875;1 0.84375 0.84375;1 0.8125 0.8125;1 0.78125 0.78125;1 0.75 0.75;1 0.71875 0.71875;1 0.6875 0.6875;1 0.65625 0.65625;1 0.625 0.625;1 0.59375 0.59375;1 0.5625 0.5625;1 0.53125 0.53125;1 0.5 0.5;1 0.46875 0.46875;1 0.4375 0.4375;1 0.40625 0.40625;1 0.375 0.375;1 0.34375 0.34375;1 0.3125 0.3125;1 0.28125 0.28125;1 0.25 0.25;1 0.21875 0.21875;1 0.1875 0.1875;1 0.15625 0.15625;1 0.125 0.125;1 0.09375 0.09375;1 0.0625 0.0625;1 0.03125 0.03125;1 0 0]);

% 创建 heatmap
heatmap(figure1,colordata1, 'ColorScaling', 'log',...
    'Colormap',[0 0.450980395078659 0.74117648601532;0.0322580635547638 0.468690693378448 0.749525606632233;0.0645161271095276 0.48640102148056 0.75787478685379;0.0967741906642914 0.504111349582672 0.766223907470703;0.129032254219055 0.521821618080139 0.774573087692261;0.161290317773819 0.539531946182251 0.782922208309174;0.193548381328583 0.557242274284363 0.791271388530731;0.225806444883347 0.57495254278183 0.799620509147644;0.25806450843811 0.592662870883942 0.807969629764557;0.290322571992874 0.610373198986053 0.816318809986115;0.322580635547638 0.628083467483521 0.824667930603027;0.354838699102402 0.645793795585632 0.833017110824585;0.387096762657166 0.663504123687744 0.841366231441498;0.419354826211929 0.681214451789856 0.849715352058411;0.451612889766693 0.698924720287323 0.858064532279968;0.483870953321457 0.716635048389435 0.866413652896881;0.516129016876221 0.734345376491547 0.874762833118439;0.548387110233307 0.752055644989014 0.883111953735352;0.580645143985748 0.769765973091125 0.891461133956909;0.612903237342834 0.787476301193237 0.899810254573822;0.645161271095276 0.805186569690704 0.908159375190735;0.677419364452362 0.822896897792816 0.916508555412292;0.709677398204803 0.840607225894928 0.924857676029205;0.74193549156189 0.858317494392395 0.933206856250763;0.774193525314331 0.876027822494507 0.941555976867676;0.806451618671417 0.893738150596619 0.949905097484589;0.838709652423859 0.91144847869873 0.958254277706146;0.870967745780945 0.929158747196198 0.966603398323059;0.903225779533386 0.946869075298309 0.974952578544617;0.935483872890472 0.964579403400421 0.98330169916153;0.967741906642914 0.982289671897888 0.991650879383087;1 1 1;1 0.96875 0.96875;1 0.9375 0.9375;1 0.90625 0.90625;1 0.875 0.875;1 0.84375 0.84375;1 0.8125 0.8125;1 0.78125 0.78125;1 0.75 0.75;1 0.71875 0.71875;1 0.6875 0.6875;1 0.65625 0.65625;1 0.625 0.625;1 0.59375 0.59375;1 0.5625 0.5625;1 0.53125 0.53125;1 0.5 0.5;1 0.46875 0.46875;1 0.4375 0.4375;1 0.40625 0.40625;1 0.375 0.375;1 0.34375 0.34375;1 0.3125 0.3125;1 0.28125 0.28125;1 0.25 0.25;1 0.21875 0.21875;1 0.1875 0.1875;1 0.15625 0.15625;1 0.125 0.125;1 0.09375 0.09375;1 0.0625 0.0625;1 0.03125 0.03125;1 0 0],...
    'YDisplayLabels',cName,...
    'XDisplayLabels',cName);

 end
 
 function createheat(colordata1, cName)
%CREATEFIGURE(colordata1)
%  COLORDATA1:  colordata

%  由 MATLAB 于 12-Nov-2018 10:19:38 自动生成

% 创建 figure
figure1 = figure('Colormap',...
    [0.945098042488098 0.854901969432831 0.854901969432831;0.945969521999359 0.841332077980042 0.841332077980042;0.946840941905975 0.827762246131897 0.827762246131897;0.947712421417236 0.814192354679108 0.814192354679108;0.948583900928497 0.800622463226318 0.800622463226318;0.949455320835114 0.787052631378174 0.787052631378174;0.950326800346375 0.773482739925385 0.773482739925385;0.951198279857635 0.759912848472595 0.759912848472595;0.952069699764252 0.746343016624451 0.746343016624451;0.952941179275513 0.732773125171661 0.732773125171661;0.953812658786774 0.719203233718872 0.719203233718872;0.95468407869339 0.705633342266083 0.705633342266083;0.955555558204651 0.692063510417938 0.692063510417938;0.956427037715912 0.678493618965149 0.678493618965149;0.957298457622528 0.66492372751236 0.66492372751236;0.958169937133789 0.651353895664215 0.651353895664215;0.95904141664505 0.637784004211426 0.637784004211426;0.959912836551666 0.624214112758636 0.624214112758636;0.960784316062927 0.610644280910492 0.610644280910492;0.961655795574188 0.597074389457703 0.597074389457703;0.962527215480804 0.583504498004913 0.583504498004913;0.963398694992065 0.569934666156769 0.569934666156769;0.964270174503326 0.556364774703979 0.556364774703979;0.965141594409943 0.54279488325119 0.54279488325119;0.966013073921204 0.529225051403046 0.529225051403046;0.966884553432465 0.515655159950256 0.515655159950256;0.967755973339081 0.502085268497467 0.502085268497467;0.968627452850342 0.488515406847 0.488515406847;0.969498932361603 0.474945545196533 0.474945545196533;0.970370352268219 0.461375653743744 0.461375653743744;0.97124183177948 0.447805792093277 0.447805792093277;0.972113311290741 0.43423593044281 0.43423593044281;0.972984731197357 0.420666038990021 0.420666038990021;0.973856210708618 0.407096177339554 0.407096177339554;0.974727690219879 0.393526315689087 0.393526315689087;0.975599110126495 0.379956424236298 0.379956424236298;0.976470589637756 0.366386562585831 0.366386562585831;0.977342069149017 0.352816671133041 0.352816671133041;0.978213489055634 0.339246809482574 0.339246809482574;0.979084968566895 0.325676947832108 0.325676947832108;0.979956448078156 0.312107056379318 0.312107056379318;0.980827867984772 0.298537194728851 0.298537194728851;0.981699347496033 0.284967333078384 0.284967333078384;0.982570827007294 0.271397441625595 0.271397441625595;0.98344224691391 0.257827579975128 0.257827579975128;0.984313726425171 0.2442577034235 0.2442577034235;0.985185205936432 0.230687826871872 0.230687826871872;0.986056625843048 0.217117965221405 0.217117965221405;0.986928105354309 0.203548088669777 0.203548088669777;0.98779958486557 0.189978212118149 0.189978212118149;0.988671004772186 0.176408335566521 0.176408335566521;0.989542484283447 0.162838473916054 0.162838473916054;0.990413963794708 0.149268597364426 0.149268597364426;0.991285383701324 0.135698720812798 0.135698720812798;0.992156863212585 0.12212885171175 0.12212885171175;0.993028342723846 0.108558982610703 0.108558982610703;0.993899762630463 0.0949891060590744 0.0949891060590744;0.994771242141724 0.0814192369580269 0.0814192369580269;0.995642721652985 0.0678493604063988 0.0678493604063988;0.996514141559601 0.0542794913053513 0.0542794913053513;0.997385621070862 0.0407096184790134 0.0407096184790134;0.998257100582123 0.0271397456526756 0.0271397456526756;0.999128520488739 0.0135698728263378 0.0135698728263378;1 0 0]);

% 创建 heatmap
heatmap(figure1,colordata1,...
    'Colormap',[0.945098042488098 0.854901969432831 0.854901969432831;0.945969521999359 0.841332077980042 0.841332077980042;0.946840941905975 0.827762246131897 0.827762246131897;0.947712421417236 0.814192354679108 0.814192354679108;0.948583900928497 0.800622463226318 0.800622463226318;0.949455320835114 0.787052631378174 0.787052631378174;0.950326800346375 0.773482739925385 0.773482739925385;0.951198279857635 0.759912848472595 0.759912848472595;0.952069699764252 0.746343016624451 0.746343016624451;0.952941179275513 0.732773125171661 0.732773125171661;0.953812658786774 0.719203233718872 0.719203233718872;0.95468407869339 0.705633342266083 0.705633342266083;0.955555558204651 0.692063510417938 0.692063510417938;0.956427037715912 0.678493618965149 0.678493618965149;0.957298457622528 0.66492372751236 0.66492372751236;0.958169937133789 0.651353895664215 0.651353895664215;0.95904141664505 0.637784004211426 0.637784004211426;0.959912836551666 0.624214112758636 0.624214112758636;0.960784316062927 0.610644280910492 0.610644280910492;0.961655795574188 0.597074389457703 0.597074389457703;0.962527215480804 0.583504498004913 0.583504498004913;0.963398694992065 0.569934666156769 0.569934666156769;0.964270174503326 0.556364774703979 0.556364774703979;0.965141594409943 0.54279488325119 0.54279488325119;0.966013073921204 0.529225051403046 0.529225051403046;0.966884553432465 0.515655159950256 0.515655159950256;0.967755973339081 0.502085268497467 0.502085268497467;0.968627452850342 0.488515406847 0.488515406847;0.969498932361603 0.474945545196533 0.474945545196533;0.970370352268219 0.461375653743744 0.461375653743744;0.97124183177948 0.447805792093277 0.447805792093277;0.972113311290741 0.43423593044281 0.43423593044281;0.972984731197357 0.420666038990021 0.420666038990021;0.973856210708618 0.407096177339554 0.407096177339554;0.974727690219879 0.393526315689087 0.393526315689087;0.975599110126495 0.379956424236298 0.379956424236298;0.976470589637756 0.366386562585831 0.366386562585831;0.977342069149017 0.352816671133041 0.352816671133041;0.978213489055634 0.339246809482574 0.339246809482574;0.979084968566895 0.325676947832108 0.325676947832108;0.979956448078156 0.312107056379318 0.312107056379318;0.980827867984772 0.298537194728851 0.298537194728851;0.981699347496033 0.284967333078384 0.284967333078384;0.982570827007294 0.271397441625595 0.271397441625595;0.98344224691391 0.257827579975128 0.257827579975128;0.984313726425171 0.2442577034235 0.2442577034235;0.985185205936432 0.230687826871872 0.230687826871872;0.986056625843048 0.217117965221405 0.217117965221405;0.986928105354309 0.203548088669777 0.203548088669777;0.98779958486557 0.189978212118149 0.189978212118149;0.988671004772186 0.176408335566521 0.176408335566521;0.989542484283447 0.162838473916054 0.162838473916054;0.990413963794708 0.149268597364426 0.149268597364426;0.991285383701324 0.135698720812798 0.135698720812798;0.992156863212585 0.12212885171175 0.12212885171175;0.993028342723846 0.108558982610703 0.108558982610703;0.993899762630463 0.0949891060590744 0.0949891060590744;0.994771242141724 0.0814192369580269 0.0814192369580269;0.995642721652985 0.0678493604063988 0.0678493604063988;0.996514141559601 0.0542794913053513 0.0542794913053513;0.997385621070862 0.0407096184790134 0.0407096184790134;0.998257100582123 0.0271397456526756 0.0271397456526756;0.999128520488739 0.0135698728263378 0.0135698728263378;1 0 0], ...
    'YDisplayLabels',cName,...
    'XDisplayLabels',cName);
 end